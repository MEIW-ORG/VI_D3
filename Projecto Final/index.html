<!--
Mestrado em Engenharia Informática e Tecnologia Web
UC Visualização de Informação
Tópico 5 - Projecto Final
Autores: Claudia Pires (1303334) / Valter Bastos (2302612)
Ficheiro HTML
-->

<!DOCTYPE html>
<html>
<head>
    <title>Visualização da Informação</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script> 
    <script src="./js/genero.js"></script>
</head>
<body>
    <h2>Visualizações</h2>

    <label><input type="radio" name="chartType" value="bar" checked> Gráfico de Barras</label>
    <label><input type="radio" name="chartType" value="map"> Mapa Mundo</label>

    <div id="chart"></div>

    <script src="./js/genero.js"></script>
    <script>
 
    const margin = { top: 20, right: 20, bottom: 30, left: 40 };

    // Definido para que os gráficos ocupem 75% das paginas
    const width = window.innerWidth * 0.75 - margin.left - margin.right;
    const height = window.innerHeight * 0.75 - margin.top - margin.bottom;

    const svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        let barChartData; // Variável para armazenar os dados do gráfico de barras

// Função para carregar e processar os dados do gráfico de barras
function loadBarChartData() {
    processGenderData('./data/Gender.json').then(processedData => {
        barChartData = Object.keys(processedData).sort().map(year => ({
            year: year,
            Male: processedData[year].Male,
            Female: processedData[year].Female
        }));
        drawBarChart(barChartData); // Desenha o gráfico de barras inicialmente
    });
}

// ------------------------------
// Grafico de Barras
// ------------------------------
function drawBarChart(data) {
    
    svg.selectAll("*").remove();

    const x = d3.scaleBand()
        .rangeRound([0, width])
        .paddingInner(0.1)
        .domain(data.map(d => d.year));

    // Encontrar o máximo valor nos dados
    const maxValue = d3.max(data, d => Math.max(d.Male, d.Female));

    // Configurar o eixo Y para ser 10% maior do que o máximo valor
    const yMax = maxValue * 1.20;

    const y = d3.scaleLinear()
        .rangeRound([height, 0])
        .domain([0, yMax]);

    // Adicionar os eixos X e Y ao SVG
    svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x));

    svg.append("g")
        .call(d3.axisLeft(y).ticks(10, "%"))
        .append("text")
        .attr("fill", "#000")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
        .text("Percentage");

    const xGender = d3.scaleBand()
        .domain(['Male', 'Female'])
        .rangeRound([0, x.bandwidth()])
        .padding(0.05);

    svg.selectAll(null)
        .data(data)
        .enter().append("g")
        .attr("transform", d => `translate(${x(d.year)},0)`)
        .selectAll("rect")
        .data(d => [{key: "Male", value: d.Male}, {key: "Female", value: d.Female}])
        .enter().append("rect")
        .attr("x", d => xGender(d.key))
        .attr("y", d => y(d.value))
        .attr("width", xGender.bandwidth())
        .attr("height", d => height - y(d.value))
        .attr("fill", d => d.key === "Male" ? "dodgerblue" : "lightcoral");
}

// ------------------------------
// Gráfico Mapa Mundo interactivo
// ------------------------------
function drawWorldMap() {
    svg.selectAll("*").remove(); // Limpa tudo no SVG

    const projection = d3.geoMercator()
        .scale(width / 2 / Math.PI)
        .translate([width / 2, height / 1.5]);

    const path = d3.geoPath().projection(projection);

    const zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
        });

    const g = svg.append('g');

    svg.call(zoom);

    // Carrega e desenha o mapa-múndi
    d3.json("https://d3js.org/world-110m.v1.json").then(world => {
        g.selectAll("path")
            .data(topojson.feature(world, world.objects.countries).features)
            .enter().append("path")
            .attr("d", path)
            .attr("fill", "lightgray")
            .attr("stroke", "white");
    });
}

// Chamadas por opção
document.querySelectorAll('input[name="chartType"]').forEach(input => {
    input.addEventListener('change', function() {
        if (this.value === 'bar') {
            drawBarChart(barChartData);
        } else if (this.value === 'map') {
            drawWorldMap();
        }
    });
});
loadBarChartData(); // Carrega os dados do gráfico de barras quando a página é carregada

</script>
</body>
</html>
